#!/bin/bash

# kubctl-0x02 â€” Blue-Green deployment script for Django app

BLUE_DEPLOY="messaging_app/blue_deployment.yaml"
GREEN_DEPLOY="messaging_app/green_deployment.yaml"
SERVICE_FILE="messaging_app/kubeservice.yaml"

echo "ğŸš€ Deploying BLUE version..."
kubectl apply -f $BLUE_DEPLOY

echo "ğŸš€ Deploying GREEN version..."
kubectl apply -f $GREEN_DEPLOY

echo "â³ Waiting for green pods to be ready..."
kubectl wait --for=condition=ready pod -l app=messaging-app,version=green --timeout=120s

echo "ğŸ“œ Checking logs for GREEN version..."
GREEN_POD=$(kubectl get pods -l app=messaging-app,version=green -o jsonpath='{.items[0].metadata.name}')
kubectl logs $GREEN_POD

echo "âœ… Switching traffic to GREEN version..."
kubectl patch service messaging-app-service -p '{"spec":{"selector":{"app":"messaging-app","version":"green"}}}'

echo "ğŸ“‹ Current service routing:"
kubectl get service messaging-app-service -o yaml | grep selector -A 3
